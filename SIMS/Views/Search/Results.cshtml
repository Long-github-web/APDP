@model dynamic
@{
    Layout = "~/Views/Shared/_MainLayout.cshtml";
    ViewData["Title"] = "Káº¿t quáº£ tĂ¬m kiáº¿m";
    ViewData["breadcrumb"] = "TĂ¬m kiáº¿m";
    ViewData["breadcrumb-item"] = "Káº¿t quáº£";
    var query = ViewData["SearchQuery"] as string ?? "";
}

<div class="container-fluid">
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">Káº¿t quáº£ tĂ¬m kiáº¿m cho: <strong>@query</strong></h5>
        </div>
        <div class="card-body">
            <div id="searchResultsContainer">
                <div class="text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Äang tĂ¬m kiáº¿m...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        (function() {
            const query = '@Html.Raw(query)';
            const container = document.getElementById('searchResultsContainer');

            async function loadSearchResults() {
                if (!query || query.trim().length < 2) {
                    container.innerHTML = '<div class="alert alert-warning">Vui lĂ²ng nháº­p tá»« khĂ³a tĂ¬m kiáº¿m (Ă­t nháº¥t 2 kĂ½ tá»±)</div>';
                    return;
                }

                try {
                    const response = await fetch(/Search/Search?query=);
                    const data = await response.json();
                    displayResults(data);
                } catch (error) {
                    console.error('Search error:', error);
                    container.innerHTML = '<div class="alert alert-danger">CĂ³ lá»—i xáº£y ra khi tĂ¬m kiáº¿m. Vui lĂ²ng thá»­ láº¡i.</div>';
                }
            }

            function displayResults(data) {
                let html = '';

                if (data.courses && data.courses.length > 0) {
                    html += '<div class="mb-4"><h5 class="text-primary mb-3"><i class="fas fa-book"></i> KhĂ³a há»c (' + data.courses.length + ')</h5><div class="table-responsive"><table class="table table-hover"><thead><tr><th>MĂ£ khĂ³a há»c</th><th>TĂªn khĂ³a há»c</th><th>Thao tĂ¡c</th></tr></thead><tbody>';
                    data.courses.forEach(course => {
                        html += '<tr><td>' + escapeHtml(course.code) + '</td><td>' + escapeHtml(course.name) + '</td><td><a href="/Course/Details/' + course.id + '" class="btn btn-sm btn-primary"><i class="fas fa-eye"></i> Xem chi tiáº¿t</a></td></tr>';
                    });
                    html += '</tbody></table></div></div>';
                }

                if (data.students && data.students.length > 0) {
                    html += '<div class="mb-4"><h5 class="text-success mb-3"><i class="fas fa-user-graduate"></i> Sinh viĂªn (' + data.students.length + ')</h5><div class="table-responsive"><table class="table table-hover"><thead><tr><th>MĂ£ sinh viĂªn</th><th>MĂ£ ID</th><th>Há» vĂ  tĂªn</th><th>Thao tĂ¡c</th></tr></thead><tbody>';
                    data.students.forEach(student => {
                        const studentIdDisplay = student.studentId || '-';
                        html += '<tr><td>' + escapeHtml(student.studentCode) + '</td><td>' + escapeHtml(studentIdDisplay) + '</td><td>' + escapeHtml(student.fullName) + '</td><td><a href="/Student/Details/' + student.id + '" class="btn btn-sm btn-success"><i class="fas fa-eye"></i> Xem chi tiáº¿t</a></td></tr>';
                    });
                    html += '</tbody></table></div></div>';
                }

                if ((!data.courses || data.courses.length === 0) && (!data.students || data.students.length === 0)) {
                    html = '<div class="alert alert-info"><i class="fas fa-info-circle"></i> KhĂ´ng tĂ¬m tháº¥y káº¿t quáº£ nĂ o cho tá»« khĂ³a "<strong>' + escapeHtml(query) + '</strong>"</div>';
                }

                container.innerHTML = html;
            }

            function escapeHtml(text) {
                const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
                return String(text).replace(/[&<>"']/g, m => map[m]);
            }

            loadSearchResults();
        })();
    </script>
}
